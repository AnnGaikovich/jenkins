pipeline {
  // Где будет выполняться пайплайн. 'any' — любой Jenkins-агент.
  agent any

  // Общие опции конвейера
  options {
    // Добавляет метки времени в лог сборки
    timestamps()
    // Обрезает историю сборок, хранит только последние 20
    buildDiscarder(logRotator(numToKeepStr: '20'))
    // Запрещает параллельные сборки одного job (полезно для локального демо)
    disableConcurrentBuilds()
  }

  // Переменные окружения для стадий
  environment {
    // Опции Maven: падать при ошибках тестов
    MAVEN_OPTS = '-Dmaven.test.failure.ignore=false'
  }

  stages {

    stage('Build') {
      steps {
        // Проверка версии Maven
        bat 'mvn -v'
        // Компиляция проекта. Параметры:
        // -B: batch mode (без интерактивных вопросов)
        // -U: принудительно обновить снапшоты (на случай зависимостей)
        dir('devA') {
                    bat 'mvn -B -U clean compile'
                }
      }
    }

    stage('Test') {
                steps {
                    dir('devA') {
                        bat 'mvn -B test'
                    }
                }
                post {
                    always {
                        junit 'devA/target/surefire-reports/*.xml'
                    }
                }
            }

            stage('Package') {
                steps {
                    dir('devA') {
                        bat 'mvn -B package'
                    }
                }
            }

    stage('Quality gates') {
      // Стадия качества включается только для веток develop и main
      when {
        anyOf {
          branch 'develop'
          branch 'main'
        }
      }
      steps {
        // Здесь можно подключить статический анализ: SpotBugs, Checkstyle, SonarQube.
        echo 'Quality checks placeholder: линтеры, статанализ, SonarQube и т.д.'
      }
    }

    stage('Deploy (local)') {
      // Условный «деплой»: выполняем только для main
      when {
        branch 'main'
      }
      steps {
        // Запуск приложения в фоне (nohup) и вывод логов в app.log
        // В учебных целях это имитация CD (continuous deployment).
        bat 'nohup java -jar target/java-maven-ci-demo-1.0.0.jar > app.log 2>&1 &'
      }
    }
  }

  // Глобальные действия после конвейера
  post {
    success {
      echo "Build successful"
    }
    failure {
      echo "Build failed"
    }
  }
}
